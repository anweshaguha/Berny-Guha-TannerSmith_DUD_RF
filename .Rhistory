load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
?getAnywhere
knitr::opts_chunk$set(echo = TRUE)
#### NOTE: BE SURE TO IMPORT "WORKSPACE_JULY142024" FOR ALL OBJECTS/MODELS HERE. WILL GET DIFFERENT RESULTS WITHOUT IT DUE TO PARALLELS; YOU MAY ENCOUNTER SOME ERRORS DUE TO PACKAGE UPDATES SINCE THIS WAS WRITTEN. ####
library(here)
library(rio)
library(janitor)
library(glmnet)
library(recipes)
library(cutpointr)
library(vip)
library(caret)
library(gtools)
library(finalfit)
library(DALEX)
library(patchwork)
library(iBreakDown)
library(r2d3)
library(gtsummary)
library(effsize)
library(epitools)
library(tidyverse)
library(ggforce)
DS1 <- import(here("36769-0001-Data.dta"))
DS2 <- import(here("36769-0002-Data.dta"))
DS3 <- import(here("36769-0003-Data.dta"))
load("bdplot_function.R")
source("bdplot_function.R")
bdplot2 <- bdplot(breakdown_lc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
select_only_k_features <- getAnywhere(select_only_k_features)[3]
prepare_data_for_break_down_plot <- getAnywhere(prepare_data_for_break_down_plot)[2]
bdplot2 <- bdplot(breakdown_lc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
source("select_only_k_features2")
source("select_only_k_features2.R")
bdplot(breakdown_lc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
source("prepare_data_for_break_down_plot2.R")
bdplot(breakdown_hc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
select_only_k_features <- getAnywhere(select_only_k_features)[3]
prepare_data_for_break_down_plot <- getAnywhere(prepare_data_for_break_down_plot)[2]
breakdown_hc$variable[1] <- "Intercept"
breakdown_hc$variable[2] <- "Drug Initiation Age = 17"
breakdown_hc$variable[3] <- "Negative Peer Influence = 2.14"
breakdown_hc$variable[4] <- "Intoxicated Driving = 0"
breakdown_hc$variable[5] <- "Non-Partner Violence Perpetration = 7"
breakdown_hc$variable[6] <- "Crime = 0"
breakdown_hc$variable[8] <- "Biological Sex = Female"
breakdown_hc$variable[11] <- "Alcohol Use Disorder = No"
breakdown_hc$variable[17] <- "Tempted - Made Fun of For Abstaining = 4"
breakdown_hc$variable[55] <- "Prediction"
breakdown_hc <- breakdown_hc %>%
mutate(label = "Simulated Case #1")
bdplot1 <- bdplot(breakdown_hc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
drugdx <- as.numeric(baked$drugdx) - 1 #outcome must be numeric (not factor)
explainer_rf <- DALEX::explain(fitted_rf_model, data = baked[,3:55],
y = drugdx) #create DALEX explainer object
explainer_rf <- DALEX::explain(fitted_rf_model, data = baked[,3:55],
y = target, type = "classification") #create DALEX explainer object
explainer_rf <- DALEX::explain(fitted_rf_model, data = baked[,3:55],
y = target) #create DALEX explainer object
load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
explainer_rf
View(explainer_rf)
explain(fitted_rf_model)
DALEX::explain(fitted_rf_model)
explain(fitted_rf_model, data = baked[,3:55],
y = target)
View(explainer_rf)
explainer_rf[["predict_function"]]
environment(explainer_rf[["predict_function"]])[["predict.explainer"]]
View(baked)
View(baked_pred)
View(rforest)
View(fitted_rf_model)
View(fitted_rf_model)
# Custom predict function for ranger classification
pred_fun <- function(model, newdata) {
# Use type = "response" to get class labels
predict(model, data = newdata, type = "response")$predictions
}
# Create explainer
explainer_rf <- DALEX::explain(
model = fitted_rf_model,
data = baked[,3:55],
y = target,
predict_function = pred_fun
)
load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
View(explainer_rf)
explainer_rf[["model_info"]][["ver"]]
explainer_rf[["predict_function"]]
out <- predict(fitted_rf_model, data = baked[,3:55], type = "response")
out <- ranger::predict(fitted_rf_model, data = baked[,3:55], type = "response")
getS3method("predict", "ranger")
out <- predict(fitted_rf_model, data = baked[,3:55], type = "response")
str(out)
pred_fun <- function(model, newdata) {
out <- predict(model, data = newdata, type = "response")$predictions
# extract "Yes" probability
return(out[, "Yes"])
}
explainer_rf <- DALEX::explain(
model = fitted_rf_model,
data = baked[, 3:55],
y = as.numeric(baked$drugdx == "Yes"),  # numeric 0/1
predict_function = pred_fun,
label = "ranger_prob_rf"
)
pred_fun <- function(model, newdata) {
out <- predict(model, data = newdata, type = "response")$predictions
# extract "Yes" probability
return(out[, "Yes"])
}
explainer_rf <- DALEX::explain(
model = fitted_rf_model,
data = baked[, 3:55],
y = target,  # numeric 0/1
predict_function = pred_fun,
label = "ranger_prob_rf"
)
load("C:/Users/laure/OneDrive - University Of Oregon/ML Manuscript/Workspace_July142024.RData")
# Total Sample
baked %>%
select(-deid) %>%
tbl_summary(
type = list(grades_rev ~ "continuous",
legalsev ~ "continuous",
pviclevel ~ "continuous",
pagglevel ~ "continuous",
crime ~ "continuous",
sedare1 ~ "continuous",
sedare2 ~ "continuous",
sedare3 ~ "continuous",
sedare4 ~ "continuous",
sedare5 ~ "continuous",
sedare6 ~ "continuous",
sedare7 ~ "continuous",
sedare8 ~ "continuous"),
statistic = list(
all_continuous() ~ "{mean} ({sd}) {min} - {max}",
all_categorical() ~ "{n} / {N} ({p}%)"),
digits = list(all_categorical() ~ 1,
all_continuous() ~ 2))
# By Group and Unadjusted Comparisons
# p_format <- function(x) {
#   ifelse(x < 0.01, "**", ifelse(x < 0.05, "*", ""))
# }
baked %>%
select(-deid) %>%
tbl_summary(
by = drugdx,
type = list(
grades_rev ~ "continuous",
legalsev ~ "continuous",
pviclevel ~ "continuous",
pagglevel ~ "continuous",
crime ~ "continuous",
sedare1 ~ "continuous",
sedare2 ~ "continuous",
sedare3 ~ "continuous",
sedare4 ~ "continuous",
sedare5 ~ "continuous",
sedare6 ~ "continuous",
sedare7 ~ "continuous",
sedare8 ~ "continuous"
),
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = list(
all_categorical() ~ 1,
all_continuous() ~ 2
),
missing_text = "(Missing)"
) %>%
add_p(
test = list(
all_continuous() ~ "t.test"
),
pvalue_fun = ~ style_pvalue(.x, digits = 3)
) %>%
# modify_table_styling(
#   columns = "p.value",
#   rows = !is.na(p.value),  # Apply to all rows where p.value is not NA
#   fmt_fun = p_format
# ) %>%
bold_p()
# Loops for Effect Sizes
# Function to calculate odds ratio for a categorical variable
calculate_odds_ratio <- function(data, var, group_var) {
contingency_table <- table(data[[var]], data[[group_var]])
odds_ratio <- oddsratio(contingency_table)$measure
return(odds_ratio)
}
# Function to calculate Cohen's d for a continuous variable
calculate_cohens_d <- function(data, var, group_var) {
groups <- split(data[[var]], data[[group_var]])
cohen_d <- cohen.d(groups[[1]], groups[[2]])
return(cohen_d)
}
# List of categorical and continuous variables
categorical_vars <- c(
"demosex", "livewith", "school", "gang1", "weapon1",
"weapon2a", "sexint", "publicass", "partnervic", "pcts", "binge",
"vgroup", "alcdx", "ptsd", "cdapd", "sexdrug", "mentman", "mentwoman",
"demoage_Age.14.to.17", "demoage_Age.18.to.20", "demoage_Age.21.to.24",
"demorac_AA.or.Black", "demorac_White", "demorac_Multiple.Races",
"demorac_American.Indian.Asian.Native.Hawaiian"
)
continuous_vars <- c(
"fight", "grades_rev", "reatt_rev", "pviclevel", "pagglevel", "agedruginit",
"legalsev", "dui", "infrndps", "infrndng", "parntsup", "prntdral",
"famanger", "nofight", "commviol", "bsi", "anx", "nprcts1to13",
"npects1to13", "crime", "sedare1", "sedare2", "sedare3", "sedare4",
"sedare5", "sedare6", "sedare7", "sedare8"
)
# Initialize lists to store results
odds_ratios <- list()
cohens_d <- list()
# Calculate odds ratios for categorical variables
for (var in categorical_vars) {
odds_ratios[[var]] <- calculate_odds_ratio(baked, var, "drugdx")
}
# Calculate Cohen's d for continuous variables
for (var in continuous_vars) {
cohens_d[[var]] <- calculate_cohens_d(baked, var, "drugdx")
}
# Display results
print("Odds Ratios for Categorical Variables:")
print(odds_ratios)
print("Cohen's d for Continuous Variables:")
print(cohens_d)
varimp <- perm %>%
mutate(permimp = `rforest[["finalModel"]][["variable.importance"]]`) %>%
dplyr::select(-`rforest[["finalModel"]][["variable.importance"]]`) %>%
arrange(desc(permimp)) %>%
dplyr::select(variable, permimp)
View(varimp)
mp_cont <- model_profile(explainer = explainer_rf, type = "conditional", N = NULL,
variables = c("dui", "infrndng",
"sedare1", "agedruginit",
"crime", "sedare4",
"grades_rev", "sedare3",
"anx"))
View(mp_cont)
ale_cont <- mp_cont[["agr_profiles"]] #pull ALEs from profile
plot(ale_cont)
mp_cat <- model_profile(explainer = explainer_rf, type = "conditional", N = NULL,
variable_type = "categorical",
variables = c("alcdx", "cdapd", "demosex"))
ale_cat <- mp_cat[["agr_profiles"]] #pull ALEs from profile
plot(ale_cat)
contvars <- data.frame(variables = c("dui", "infrndng", "agedruginit", "crime",
"bsi", "legalsev", "npects1to13", "infrndps",
"famanger", "nofight", "parntsup", "sedare1",
"sedare2", "sedare3", "sedare4", "sedare5",
"sedare6", "sedare7", "sedare8", "anx", "grades_rev"),
labels = c("Intoxicated Driving",
"Negative Peer Influence", "Drug Initiation Age",
"Crime", "Depression",
"Legal Severity", "Non-Partner Violence Perpetration",
"Positive Peer Influence", "Family Anger", "Fight Avoidance",
"Parent Support", "Tempted - Let Myself Down",
"Tempted - People Didn't Like Me",
"Tempted - Friend Problems",
"Tempted - Family Problems",
"Tempted - Made Fun of For Abstaining",
"Tempted - Friends Would Like Me More",
"Tempted - All Friends Were Doing It",
"Tempted - Worried About a Problem", "Anxiety",
"Academic Performance"))
labels_lookup <- contvars %>%
mutate(`_vname_` = variables) %>%
relocate(`_vname_`) %>%
select(-variables)
catvars <- data.frame(variables = c("alcdx", "cdapd", "demosex"),
labels = c("Alcohol Use Disorder", "Conduct Disorder or ASPD",
"Biological Sex"))
labels_lookup2 <- catvars %>%
mutate(`_vname_` = variables) %>%
relocate(`_vname_`) %>%
select(-variables)
# Create an empty list to store the plots
plot_list <- list()
# Get unique values of _vname_
unique_vnames <- unique(ale_cont$`_vname_`)
# Loop through each unique vname and create plots
for (vname in unique_vnames) {
subset_data <- subset(ale_cont, `_vname_` == vname)
# Get the corresponding label from the lookup table
label <- labels_lookup$label[labels_lookup$`_vname_` == vname]
# Calculate the mean value of the corresponding variable in the baked dataframe
mean_value <- mean(baked[[vname]], na.rm = TRUE)
p <- ggplot(data = subset_data, aes(x = `_x_`, y = `_yhat_`)) +
geom_vline(xintercept = mean_value, linetype = "dashed", color = "black") +
geom_line(color = "#371ea3", linewidth = 1.5) +
geom_rug(data = baked, aes(x = .data[[vname]]), sides="b", alpha = .15, linewidth = 1.25,
inherit.aes = FALSE, length = unit(0.15,"cm")) +
labs(x = label, y = "") +
scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05))) +
theme_bw() +
theme(legend.position = "none",
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11),
axis.title.x = element_text(size = 12))
# Save the plot in the list with a unique name
plot_list[[vname]] <- p
# Optionally display the plot
print(p)
}
# Create an empty list to store the plots
plot_list2 <- list()
# Get unique values of _vname_
unique_vnames2 <- unique(ale_cat$`_vname_`)
# Loop through each unique vname and create plots
for (vname in unique_vnames2) {
subset_data <- subset(ale_cat, `_vname_` == vname)
# Get the corresponding label from the lookup table
label <- labels_lookup2$label[labels_lookup2$`_vname_` == vname]
p2 <- ggplot(data = subset_data, aes(x = `_x_`, y = `_yhat_`)) +
geom_col(color = "black",fill = "#371ea3", width = .5, size = .75) +
labs(x = label, y = "") +
scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05))) +
theme_bw() +
theme(legend.position = "none",
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11),
axis.title.x = element_text(size = 12))
# Save the plot in the list with a unique name
plot_list2[[vname]] <- p2
# Optionally display the plot
print(p2)
}
# Function to save ggplot objects from a list to the environment
save_ggplots_to_workspace <- function(plot_list, prefix = "ale") {
for (plot_name in names(plot_list)) {
assign(paste0(prefix, "_", plot_name), plot_list[[plot_name]], envir = .GlobalEnv)
}
}
# Save plots from plot_list to the workspace
save_ggplots_to_workspace(plot_list)
# Save plots from plot_list2 to the workspace
save_ggplots_to_workspace(plot_list2)
ales <- ale_dui + ale_infrndng +
ale_alcdx + ale_sedare1 +
ale_cdapd + ale_agedruginit +
ale_crime + ale_demosex +
ale_grades_rev + ale_anx +
ale_sedare3 + ale_sedare4 +
plot_layout(nrow = 6, byrow = TRUE) +
plot_annotation(tag_levels = 'A')
ales_wrapped <- wrap_elements(ales) +
labs(tag = "Predicted Probability") +
theme(plot.tag = element_text(size = rel(1.2), angle = 90),
plot.tag.position = "left")
ales_wrapped
ales
ale_dui
ales
source("bdplot_function.R")
source("select_only_k_features2.R")
source("prepare_data_for_break_down_plot2.R")
select_only_k_features <- getAnywhere(select_only_k_features)[3]
prepare_data_for_break_down_plot <- getAnywhere(prepare_data_for_break_down_plot)[2]
breakdown_hc$variable[1] <- "Intercept"
breakdown_hc$variable[2] <- "Drug Initiation Age = 17"
breakdown_hc$variable[3] <- "Negative Peer Influence = 2.14"
breakdown_hc$variable[4] <- "Intoxicated Driving = 0"
breakdown_hc$variable[5] <- "Non-Partner Violence Perpetration = 7"
breakdown_hc$variable[6] <- "Crime = 0"
breakdown_hc$variable[8] <- "Biological Sex = Female"
breakdown_hc$variable[11] <- "Alcohol Use Disorder = No"
breakdown_hc$variable[17] <- "Tempted - Made Fun of For Abstaining = 4"
breakdown_hc$variable[55] <- "Prediction"
breakdown_hc <- breakdown_hc %>%
mutate(label = "Simulated Case #1")
bdplot1 <- bdplot(breakdown_hc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
breakdown_lc$variable[1] <- "Intercept"
breakdown_lc$variable[2] <- "Tempted - Let Myself Down  = 5"
breakdown_lc$variable[3] <- "Positive Peer Influence = 3.5"
breakdown_lc$variable[4] <- "Intoxicated Driving = 0"
breakdown_lc$variable[5] <- "Community Violence = 1"
breakdown_lc$variable[6] <- "Depression = 15"
breakdown_lc$variable[8] <- "Crime = 0"
breakdown_lc$variable[13] <- "Conduct Disorder or ASPD = No"
breakdown_lc$variable[15] <- "Non-Partner Violence Perpetration = 0"
breakdown_lc$variable[55] <- "Prediction"
breakdown_lc <- breakdown_lc %>%
mutate(label = "Simulated Case #2")
bdplot2 <- bdplot(breakdown_lc, max_features = 8) + scale_y_continuous(limits = c(.40, .65)) +
labs(y = "Predicted Probability")
breakdowns <- bdplot1 + bdplot2 +
plot_layout(nrow = 2, byrow = TRUE) +
plot_annotation(tag_levels = 'A')
bds_wrapped <- wrap_elements(breakdowns)
breakdowns
hc_only <- baked2[1,]
cp1_hc <- cp1_hc %>%
rowwise() %>%
mutate(x = get(`_vname_`))
labels_lookup <- contvars %>%
mutate(`_vname_` = variables) %>%
relocate(`_vname_`) %>%
select(-variables)
# Create an empty list to store the plots
plot_list3 <- list()
# Get unique values of _vname_
unique_vnames3 <- unique(cp1_hc$`_vname_`)
# Loop through each unique vname and create plots
for (vname in unique_vnames3) {
subset_data <- subset(cp1_hc, `_vname_` == vname)
# Get the corresponding label from the lookup table
label <- labels_lookup$label[labels_lookup$`_vname_` == vname]
# Get value of the case's corresponding variable
value <- hc_only[[vname]]
p <- ggplot(data = subset_data, aes(x = x, y = `_yhat_`)) +
geom_line(color = "#371ea3", linewidth = 1.5) +
geom_point(x = value, y = 0.4758262, shape = 23, size = 3, fill = "#8bdcbe",
color = "black") +
labs(x = label, y = "") +
scale_y_continuous(limits = c(.35, .55), expand = expansion(mult = c(0, 0.05))) +
theme_bw() +
theme(legend.position = "none",
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11),
axis.title.x = element_text(size = 12))
# Save the plot in the list with a unique name
plot_list3[[vname]] <- p
# Optionally display the plot
print(p)
}
hc_only
plot(cp1_hc, variables = c("infrndng", "npects1to13"))
plot(cp1_hc, variables = c("infrndng", "npects1to13"))
plot_list3
View(plot_list3)
plot_list3[["infrndng"]]
plot_list3
View(plot_list)
View(plot_list3)
combined_plot <-
bdplot1 / (plot_list3[["infrndng"]] | plot_list3[["npects1to13"]]) +
plot_annotation(
tag_levels = "A",
tag_prefix = "",
tag_suffix = "",
theme = theme(
plot.tag = element_text(size = 18, face = "bold")
)
)
combined_plot
cps <- cp_infrndng + cp_npects1to13 +
plot_layout(nrow = 2, byrow = TRUE) +
plot_annotation(tag_levels = list(c('B1', 'B2')))
cps
cps <- plot_list3[["infrndng"]] + plot_list3[["npects1to13"]] +
plot_layout(nrow = 2, byrow = TRUE) +
plot_annotation(tag_levels = list(c('B1', 'B2')))
cps
cps <- plot_list3[["infrndng"]] + plot_list3[["npects1to13"]] +
plot_layout(nrow = 1, byrow = TRUE) +
plot_annotation(tag_levels = list(c('B1', 'B2')))
cps
cps_wrapped <- wrap_elements(cps) +
labs(tag = "Predicted Probability") +
theme(plot.tag = element_text(size = rel(1.1), angle = 90),
plot.tag.position = "left") + theme(plot.margin = unit(c(0, 0, 0, 0), "null"),
panel.spacing = unit(c(0, 0, 0, 0), "null"))
cps_wrapped
bds_wrapped <- breakdown_hc + theme(plot.margin = unit(c(0, 0, 0, 0), "null"),
panel.spacing = unit(c(0, 0, 0, 0), "null"))
localplots <- breakdown_hc / free(cps_wrapped) +
plot_layout(heights = c(1.75, 1.35))
breakdown_hc / free(cps_wrapped)
breakdown_hc
localplots <- bdplot1 / free(cps_wrapped) +
plot_layout(heights = c(1.75, 1.35))
localplots
bds_wrapped <- bdplot1 + theme(plot.margin = unit(c(0, 0, 0, 0), "null"),
panel.spacing = unit(c(0, 0, 0, 0), "null"))
localplots <- bds_wrapped / free(cps_wrapped) +
plot_layout(heights = c(1.75, 1.35))
localplots
bds_wrapped
bdplot1
bdplot1 +
plot_layout(nrow = 1, byrow = TRUE) +
plot_annotation(tag_levels = list(c(A)))
bds_wrapped <- bdplot1 +
plot_layout(nrow = 1, byrow = TRUE) +
plot_annotation(tag_levels = list(c('A')))
bds_wrapped
bds_wrapped
bds_wrapped <- bdplot1 + theme(plot.margin = unit(c(0, 0, 0, 0), "null"),
panel.spacing = unit(c(0, 0, 0, 0), "null"))
bds_wrapped
bds_wrapped <- bdplot1 +
plot_layout(nrow = 1, byrow = TRUE) +
plot_annotation(tag_levels = list(c('A')))
localplots <- bds_wrapped / free(cps_wrapped) +
plot_layout(heights = c(1.75, 1.35))
localplots
bds_wrapped
View(lc_unc_joined)
